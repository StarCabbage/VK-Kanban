<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VK-Kanban</title>
    <link href="styles.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
</head>
<body>


<div class="scrolling-wrapper-flexbox space_element" id="columnBox">


</div>


<script>

    //drag


    window.absolute = null;
    window.highlight = false;
    window.last_mouse_over_element = null;

    function mouseover_listener(ev) {
        //window.above = ev;
        console.log('mousemove');
        console.log(absolute);
        if (window.absolute) {
            window.last_event = ev;
            //console.log(ev.target);
            //console.log('+++++++++++');
            //console.log(window.last_el);
            if (ev.target.closest('.task-block')) {
                console.log('gon');
                console.log(window.last_mouse_over_element);
                if (window.last_mouse_over_element !== ev.target.closest('.task-block')) {
                    removeHighlight();
                    window.highlight = true;
                    window.last_mouse_over_element = ev.target.closest('.task-block');
                }
                /**
                 * TODO highlight
                 * **/

                /*console.log('белая карта-' + `${window.last_event.target.offsetTop}-${window.last_event.target.offsetTop + window.last_event.target.offsetHeight}
            -${window.last_event.target.offsetLeft}-${window.last_event.target.offsetLeft + window.last_event.target.offsetWidth}-${window.last_event.target.offsetHeight}
            -${initialY}-${initialX}
            `);

                if (window.last_el !== ev.target) {
                    window.changed = true;
                    console.log('chan');
                    window.last_el = ev.target;
                }
                   */
            } else if (ev.target.closest('.card')) {
                console.log('gan');
                console.log(window.last_mouse_over_element);
                /*console.log('нет, не белая карта, в таком случае ищем блок');
                console.log(`${card.offsetTop}-${card.offsetTop + card.offsetHeight}
                -${card.offsetLeft}-${card.offsetLeft + card.offsetWidth}
            -${initialY}-${initialX}
            `);
                console.log(window.last_event.target.closest('.card'));*/
                let card = ev.target.closest('.card');
                if (window.last_mouse_over_element !== card) {
                    removeHighlight();

                    window.highlight = true;
                    window.last_mouse_over_element = card;
                }
            }
        }
    }


    function mousemove_listener(event) {
        if (window.absolute) {
            let eventDoc, doc, body;


            event = event || window.event; // IE-ism

            // If pageX/Y aren't available and clientX/Y are,
            // calculate pageX/Y - logic taken from jQuery.
            // (This is to support old IE)
            if (event.pageX == null && event.clientX != null) {
                eventDoc = (event.target && event.target.ownerDocument) || document;
                doc = eventDoc.documentElement;
                body = eventDoc.body;

                event.pageX = event.clientX +
                    (doc && doc.scrollLeft || body && body.scrollLeft || 0) -
                    (doc && doc.clientLeft || body && body.clientLeft || 0);
                event.pageY = event.clientY +
                    (doc && doc.scrollTop || body && body.scrollTop || 0) -
                    (doc && doc.clientTop || body && body.clientTop || 0);
            }

            initialX = event.pageX;
            initialY = event.pageY;


            window.absolute.style.top = `${event.pageY - yOff}px`;
            window.absolute.style.left = `${event.pageX - xOff}px`;


            if (window.last_highlight) {
                if (initialY < last_highlight.offsetTop || initialY > last_highlight.offsetTop + last_highlight.offsetHeight ||
                    initialX < last_highlight.offsetLeft || initialX > last_highlight.offsetLeft + last_highlight.offsetWidth
                ) {
                    removeHighlight();
                    window.last_mouse_over_element = null;
                }
            }
            if (window.highlight) {
                window.highlight = false;
                addHighlight();


            }


        }
    }

    function removeHighlight() {
        if (window.last_highlight) {
            if (window.last_highlight.element.classList.contains('removable')) {
                removeElement(window.last_highlight.element);
            } else {
                window.last_highlight.element.style.height = '0';
                window.last_highlight.element.classList.remove('norm-card');
            }
        }
        window.last_highlight = null;
    }

    function addHighlight() {
        let offsetTop = window.last_mouse_over_element.offsetTop,
            offsetHeight = window.last_mouse_over_element.offsetHeight;
        window.last_highlight = {};
        if (window.last_mouse_over_element.classList.contains('card')) {

            console.log('kokokoko');

            let cards_list = window.last_mouse_over_element.getElementsByClassName('cards_list')[0];
            cards_list.innerHTML += `<div style=" margin-bottom: 8px;" class="removable norm-card">
                        </div>`;
            cards_list.getElementsByClassName('removable')[0].style.height = `${window.absolute.offsetHeight - 20}px`;
            window.last_highlight.element = cards_list.getElementsByClassName('removable')[0];


        } else {
            console.log('goes_here');
            let place_to_insert = window.last_mouse_over_element.getElementsByClassName('place-to-insert')[0];
            place_to_insert.classList.add('norm-card');
            place_to_insert.style.height = `${window.absolute.offsetHeight - 20}px`;
            window.last_highlight.element = place_to_insert;
            //offsetTop = window.last_mouse_over_element.offsetTop;
            //offsetHeight = window.last_mouse_over_element.offsetHeight;
        }


        window.last_highlight.offsetTop = window.last_mouse_over_element.offsetTop;
        window.last_highlight.offsetHeight = window.last_mouse_over_element.offsetHeight;
        window.last_highlight.offsetLeft = window.last_mouse_over_element.offsetLeft;
        window.last_highlight.offsetWidth = window.last_mouse_over_element.offsetWidth;

    }


    let active = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;
    let xOff = 0;
    let yOff = 0;

    function dragStart(e) {
        console.log('opa');
        console.log(e);
        console.log('opa');
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        window.touched_element = e.target.closest('.task-block');
        console.log(window.touched_element);
        window.touch_card = e.target;
        //window.absolute = e.target;

        e.target.closest('.task-block').removeAttribute('onmouseover');
        e.target.closest('.task-block').removeEventListener('mouseover', mouseover_listener);

        let clone_node = e.target.cloneNode(true);
        clone_node.classList.add('absolute');

        clone_node.removeAttribute('onmouseover');
        clone_node.removeAttribute('onmousedown');
        clone_node.style.height = `${clone_node.offsetHeight - 20}px`;
        clone_node.style.width = `${e.target.offsetWidth - 20}px`;
        clone_node.classList.add('nice-font');
        window.event = null;
        xOff = e.offsetX;
        yOff = e.offsetY;
        //console.log(`${initialX}-${xOff}-${initialX - xOff}`);

        //clone_node.style.transform ="rotate(7deg)";
        //clone_node.style.width = ev.
        document.body.appendChild(clone_node);
        //clone_node.removeEventListener('mousedown', dragStart);
        //clone_node.addEventListener('mouseover', mouseover_listener);
        //clone_node.removeEventListener('mouseover', mouseover_listener);
        //clone_node.removeEventListener('mouseover', mouseover_listener, true);
        clone_node.style.left = `${initialX - xOff}px`;
        clone_node.style.top = `${initialY - yOff}px`;
        window.absolute = clone_node;

        //clone_node.classList.add('absolute');
        //document.appendChild(clone_node);
        e.target.classList.add('hide');

        active = true;


    }


    function setTranslate(xPos, yPos, el) {
        el.style.transform = "translate3d(" + xPos - xOff + "px, " + yPos - yOff + "px, 0)";
    }


    //drag

    function setBackground(image, xCenter, yCenter) {
        document.body.style.background = `url('${image}') ${xCenter} ${yCenter} no-repeat fixed`; //требуется спец коофиценты для настройки для разных форматов экрана
    }

    function removeElement(elementId) {
        // Removes an element from the document
        let element = elementId;
        if (typeof elementId !== typeof (null)) {
            element = document.getElementById(elementId);
        }
        element.parentNode.removeChild(element);
    }

    function closeColumn(ev) {

        removeElement(ev.closest('.card'));

    }

    function closeTaskInput(ev) {
        let card_container = ev.closest('.card-container');
        removeElement(ev.closest('.input_block'));
        card_container.innerHTML += `<div class="grey-text-color" onclick="openTaskInput(this)" style="display: flex;  font-weight: 400;
    align-items: center;"><i class="material-icons" style="padding-right: 5px;">
            add
        </i>
            <div >Добавить ещё одну карточку</div>
        </div>`;
    }

    function saveTaskName(ev) {
        let card = ev.closest('.card');
        let input = card.getElementsByClassName('textarea')[0];
        let title = input.value;
        if (title !== "") {
            let id = kanbanManager.saveColumnCard(title, card.id);
            let card_container = ev.closest('.card-container');
            let input_block = card_container.getElementsByClassName('input_block')[0];
            removeElement(input_block);
            let cards_list = card_container.getElementsByClassName('cards_list')[0];
            cards_list.classList.add('card-list-normal');
            cards_list.classList.remove('card-list-with-input');
            cards_list.innerHTML += `<div id="card_${id}"  onmouseover="mouseover_listener(event)" class="task-block">
        <div class="place-to-insert">

        </div>
        <div  onmousedown="dragStart(event)"  class=" white-card">
            ${title}
        </div>

    </div>`;

            card_container.innerHTML += `<div class="grey-text-color" onmouseover="mouseover_listener(event)" onclick="openTaskInput(this)" style="display: flex;  font-weight: 400;
    align-items: center;"><i class="material-icons" style="padding-right: 5px;">
            add
        </i>
            <div>Добавить ещё одну карточку</div>
        </div>`;
        } else {
            alert('Заполните поле')
        }
    }

    function openTaskInput(ev) {
        let card_container = ev.closest('.card-container');
        removeElement(ev);
        let cards_list = card_container.getElementsByClassName('cards_list')[0];
        cards_list.classList.add('card-list-with-input');
        cards_list.classList.remove('card-list-normal');
        card_container.innerHTML += `<div class="input_block">
                <div class="white-card" style="color: grey;

    font-weight: 300;">
  <textarea type="text" class="textarea" id="inp" placeholder="Введите название карточки" style="


"></textarea>
                </div>





            <div class="grey-text-color" style="display: flex;  font-weight: 400; justify-content: space-between;
    align-items: center;">

                <div class="green-flat-button save_column_name" onclick="saveTaskName(this)">Добавить карточку</div>
                <i class="material-icons close_column" onclick="closeTaskInput(this);" style="padding-right: 5px;">
                    close
                </i>

            </div></div>`;
    }

    function saveColumnName(ev) {
        let card = ev.closest('.card');

        let input = card.getElementsByClassName('textarea')[0];
        let title = input.value;
        if (title !== "") {
            ev.closest('.card').id = kanbanManager.saveColumn(title);
            card.getElementsByClassName('card-container')[0].innerHTML = `<div  style="    font-weight: 800;
     padding-bottom: 5px;">
            ${title}
        </div>
        <div class="cards_list card-list-normal" >


        </div>

        <div class="grey-text-color" onmouseover="mouseover_listener(event)" onclick="openTaskInput(this)" style="display: flex;  font-weight: 400;
    align-items: center;"><i class="material-icons" style="padding-right: 5px;">
            add
        </i>
            <div>Добавить ещё одну карточку</div>
        </div>`;
        } else {
            alert("Заполните поле")
        }
    }

    function addElement(parentId, elementTag, elementId, html) {
        // Adds an element to the document
        var p = document.getElementById(parentId);
        var newElement = document.createElement(elementTag);
        newElement.setAttribute('id', elementId);
        newElement.innerHTML = html;
        p.appendChild(newElement);
    }

    class KanbanManager {
        constructor(kanbanTasks = []) {
            if (kanbanTasks.length === 0) {
                this.columns = 0;
                this.addColumn();
                this.columnArray = [];
                this.cardsArray = [];
                this.columnsData = {};
            }
        }

        saveColumnCard(name, columnId) {
            this.cardsArray.push(name);
            let cardId = this.cardsArray.length - 1;
            let num = parseInt(columnId.split('_')[1]);

            if (!this.columnsData[num]) this.columnsData[num] = [];
            this.columnsData[num].push(cardId);
            return cardId;
        }

        moveColumnCard(id, oldColumnId, newColumnId, newPosition) {
            console.log(`id${id}-oldColumnId${oldColumnId}-newColumnId${newColumnId}-newPos${newPosition}`);
            console.log(this.columnsData);

            this.removeColumnCard(id, oldColumnId);
            this.appendColumnCard(id, newColumnId, newPosition);

            console.log(this.columnsData);
        }

        removeColumnCard(id, columnId) {
            let num = parseInt(columnId.split('_')[1]);
            let card_id = parseInt(id.split('_')[1]);
            let index = this.columnsData[num].indexOf(card_id);
            if (!this.columnsData[num]) this.columnsData[num] = [];
            this.columnsData[num].splice(index, 1);
        }

        appendColumnCard(id, columnId, position) {
            let num = parseInt(columnId.split('_')[1]);
            let card_id = parseInt(id.split('_')[1]);
            let index = position;
            if (!this.columnsData[num]) this.columnsData[num] = [];
            this.columnsData[num].splice(index, 0, card_id);
        }

        saveColumn(name) {
            this.columnArray.push(name);
            return `column_${this.columnArray.length}`;
        }

        addColumn() {
            let columnButtonElement = `<div class="card button column">
                                        <div class="card-container nice-font">
                                            <div class="grey-text-color" style="display: flex;  font-weight: 400;
    align-items: center;"><i class="material-icons" style="padding-right: 5px;">
                                                                                        add
                                                                                     </i>
                                                  <div>Добавить ещё одну колонку</div>
                                            </div>
                                            </div>
                                        </div>`;
            document.getElementById('columnBox').innerHTML += columnButtonElement;
            let column_element = document.getElementsByClassName(`column`);
            column_element = column_element[column_element.length - 1];
            /**TODO исправить не очень хорошее решение... **/
            column_element.addEventListener('click', () => {
                //console.log(ev);
                removeElement(column_element.getElementsByClassName('grey-text-color')[0]);
                let cardContainer = column_element.getElementsByClassName('card-container')[0];
                cardContainer.innerHTML += `
                <div class="white-card" style="color: grey;

    font-weight: 300;">
  <textarea type="text" class="textarea" id="inp" placeholder="Введите название колонки" style="


"></textarea>
                </div>





            <div class="grey-text-color" style="display: flex;  font-weight: 400; justify-content: space-between;
    align-items: center;">

                <div class="green-flat-button save_column_name" onclick="saveColumnName(this)">Добавить колонку</div>
                <i class="material-icons close_column" onclick="closeColumn(this);" style="padding-right: 5px;">
                    close
                </i>

            </div>`;
                this.addColumn();
            }, {once: true});


            console.log(this.columns)
        }
    }


    let variables = {
        backgroundPath: 'background.png',
        addCard: 'Добавить ещё одну карточку'

    };

    function autoExpandTextArea() {
        document.addEventListener('input', function (event) {
            if (event.target.tagName.toLowerCase() !== 'textarea') return;
            autoExpand(event.target);
        }, false);
    }

    function autoExpand(field) {

        field.style.height = 'inherit';


        let computed = window.getComputedStyle(field);


        let height = parseInt(computed.getPropertyValue('border-top-width'), 10)
            + parseInt(computed.getPropertyValue('padding-top'), 10)
            + field.scrollHeight
            + parseInt(computed.getPropertyValue('padding-bottom'), 10)
            + parseInt(computed.getPropertyValue('border-bottom-width'), 10);

        field.style.height = height + 'px';
    }

    function initPage() {
        setBackground(variables.backgroundPath, '20%', '60%');
        autoExpandTextArea();
        window.kanbanManager = new KanbanManager();
    }

    window.onload = function () {
        initPage();
        document.onmousemove = mousemove_listener;
        document.onmouseup = up;
    };

    function up(ev) {
        //console.log(ev);


        if (window.absolute) {
            window.absolute.classList.add('hide');
            console.log('up');
            console.log(window.touched_element);
            let highlight_cards = document.getElementsByClassName('norm-card');
            console.log(highlight_cards);
            if (highlight_cards.length === 0) {
                //let white_card = window.touched_element.getElementsByClassName('white-card')[0];
                //console.log(window.touched_element.getElementsByClassName('white-card'));
                //console.log('white card');
                //console.log(JSON.stringify(white_card));
                document.getElementById(window.touched_element.id).getElementsByClassName('white-card')[0].classList.remove('hide'); //это из-за веселого бага)))
                document.getElementById(window.touched_element.id).setAttribute('onmouseover', "mouseover_listener(event)");
                document.getElementById(window.touched_element.id).addEventListener('mouseover', mouseover_listener);
                window.touch_card.classList.remove('hide');
                window.touch_card.classList.remove('hide');


            } else {

                //console.log(window.touched_element.id);
                let touched_element = document.getElementById(window.touched_element.id);
                let clone_node = touched_element.cloneNode(true);
                let oldColumnId = touched_element.closest('.card').id;
                removeElement(touched_element);
                let x_column = highlight_cards[0].closest('.card');
                let list_possible_highlights = x_column.getElementsByClassName('place-to-insert');
                let count = 0;
                let position = -1;
                for (let element of list_possible_highlights) {
                    if (element !== highlight_cards[0]) {
                        count += 1;
                    } else {
                        position = count;
                        break;
                    }
                }
                let card_list = x_column.getElementsByClassName('cards_list')[0];
                clone_node.getElementsByClassName('white-card')[0].classList.remove('hide');
                clone_node.setAttribute('onmouseover', "mouseover_listener(event)");
                clone_node.addEventListener('mouseover', mouseover_listener);
                if (position === -1) {
                    console.log('append');

                    card_list.appendChild(clone_node);
                    kanbanManager.moveColumnCard(clone_node.id, oldColumnId, x_column.id, count + 1);
                } else {
                    let x_task_blocks = x_column.getElementsByClassName('task-block');
                    card_list.insertBefore(clone_node, x_task_blocks[position]);
                    kanbanManager.moveColumnCard(clone_node.id, oldColumnId, x_column.id, position);
                }

            }
            setTimeout(function () {
                removeHighlight();
                //removeElement(pipa);
                removeElement(window.absolute);
                ///window.touched_element.id
                window.last_mouse_over_element = null;
                window.touch_card = null;
                window.touched_element = null;
                window.absolute = null;

            }, 200);


        }
    }


</script>
</body>
</html>